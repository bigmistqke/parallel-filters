(function(){"use strict";/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const proxyMarker=Symbol("Comlink.proxy"),createEndpoint=Symbol("Comlink.endpoint"),releaseProxy=Symbol("Comlink.releaseProxy"),finalizer=Symbol("Comlink.finalizer"),throwMarker=Symbol("Comlink.thrown"),isObject=e=>typeof e=="object"&&e!==null||typeof e=="function",proxyTransferHandler={canHandle:e=>isObject(e)&&e[proxyMarker],serialize(e){const{port1:r,port2:t}=new MessageChannel;return expose(e,r),[t,[t]]},deserialize(e){return e.start(),wrap(e)}},throwTransferHandler={canHandle:e=>isObject(e)&&throwMarker in e,serialize({value:e}){let r;return e instanceof Error?r={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:r={isError:!1,value:e},[r,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},transferHandlers=new Map([["proxy",proxyTransferHandler],["throw",throwTransferHandler]]);function isAllowedOrigin(e,r){for(const t of e)if(r===t||t==="*"||t instanceof RegExp&&t.test(r))return!0;return!1}function expose(e,r=globalThis,t=["*"]){r.addEventListener("message",function i(s){if(!s||!s.data)return;if(!isAllowedOrigin(t,s.origin)){console.warn(`Invalid origin '${s.origin}' for comlink proxy`);return}const{id:g,type:a,path:c}=Object.assign({path:[]},s.data),l=(s.data.argumentList||[]).map(fromWireValue);let o;try{const n=c.slice(0,-1).reduce((u,y)=>u[y],e),f=c.reduce((u,y)=>u[y],e);switch(a){case"GET":o=f;break;case"SET":n[c.slice(-1)[0]]=fromWireValue(s.data.value),o=!0;break;case"APPLY":o=f.apply(n,l);break;case"CONSTRUCT":{const u=new f(...l);o=proxy(u)}break;case"ENDPOINT":{const{port1:u,port2:y}=new MessageChannel;expose(e,y),o=transfer(u,[u])}break;case"RELEASE":o=void 0;break;default:return}}catch(n){o={value:n,[throwMarker]:0}}Promise.resolve(o).catch(n=>({value:n,[throwMarker]:0})).then(n=>{const[f,u]=toWireValue(n);r.postMessage(Object.assign(Object.assign({},f),{id:g}),u),a==="RELEASE"&&(r.removeEventListener("message",i),closeEndPoint(r),finalizer in e&&typeof e[finalizer]=="function"&&e[finalizer]())}).catch(n=>{const[f,u]=toWireValue({value:new TypeError("Unserializable return value"),[throwMarker]:0});r.postMessage(Object.assign(Object.assign({},f),{id:g}),u)})}),r.start&&r.start()}function isMessagePort(e){return e.constructor.name==="MessagePort"}function closeEndPoint(e){isMessagePort(e)&&e.close()}function wrap(e,r){return createProxy(e,[],r)}function throwIfProxyReleased(e){if(e)throw new Error("Proxy has been released and is not useable")}function releaseEndpoint(e){return requestResponseMessage(e,{type:"RELEASE"}).then(()=>{closeEndPoint(e)})}const proxyCounter=new WeakMap,proxyFinalizers="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{const r=(proxyCounter.get(e)||0)-1;proxyCounter.set(e,r),r===0&&releaseEndpoint(e)});function registerProxy(e,r){const t=(proxyCounter.get(r)||0)+1;proxyCounter.set(r,t),proxyFinalizers&&proxyFinalizers.register(e,r,e)}function unregisterProxy(e){proxyFinalizers&&proxyFinalizers.unregister(e)}function createProxy(e,r=[],t=function(){}){let i=!1;const s=new Proxy(t,{get(g,a){if(throwIfProxyReleased(i),a===releaseProxy)return()=>{unregisterProxy(s),releaseEndpoint(e),i=!0};if(a==="then"){if(r.length===0)return{then:()=>s};const c=requestResponseMessage(e,{type:"GET",path:r.map(l=>l.toString())}).then(fromWireValue);return c.then.bind(c)}return createProxy(e,[...r,a])},set(g,a,c){throwIfProxyReleased(i);const[l,o]=toWireValue(c);return requestResponseMessage(e,{type:"SET",path:[...r,a].map(n=>n.toString()),value:l},o).then(fromWireValue)},apply(g,a,c){throwIfProxyReleased(i);const l=r[r.length-1];if(l===createEndpoint)return requestResponseMessage(e,{type:"ENDPOINT"}).then(fromWireValue);if(l==="bind")return createProxy(e,r.slice(0,-1));const[o,n]=processArguments(c);return requestResponseMessage(e,{type:"APPLY",path:r.map(f=>f.toString()),argumentList:o},n).then(fromWireValue)},construct(g,a){throwIfProxyReleased(i);const[c,l]=processArguments(a);return requestResponseMessage(e,{type:"CONSTRUCT",path:r.map(o=>o.toString()),argumentList:c},l).then(fromWireValue)}});return registerProxy(s,e),s}function myFlat(e){return Array.prototype.concat.apply([],e)}function processArguments(e){const r=e.map(toWireValue);return[r.map(t=>t[0]),myFlat(r.map(t=>t[1]))]}const transferCache=new WeakMap;function transfer(e,r){return transferCache.set(e,r),e}function proxy(e){return Object.assign(e,{[proxyMarker]:!0})}function toWireValue(e){for(const[r,t]of transferHandlers)if(t.canHandle(e)){const[i,s]=t.serialize(e);return[{type:"HANDLER",name:r,value:i},s]}return[{type:"RAW",value:e},transferCache.get(e)||[]]}function fromWireValue(e){switch(e.type){case"HANDLER":return transferHandlers.get(e.name).deserialize(e.value);case"RAW":return e.value}}function requestResponseMessage(e,r,t){return new Promise(i=>{const s=generateUUID();e.addEventListener("message",function g(a){!a.data||!a.data.id||a.data.id!==s||(e.removeEventListener("message",g),i(a.data))}),e.start&&e.start(),e.postMessage(Object.assign({id:s},r),t)})}function generateUUID(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}const Api={process:(buffer,width,callback,from,to)=>{const cb=eval(callback),target=new Uint8ClampedArray(buffer),src=target.slice();for(let e=from||0;e<(to||target.length);e++)target[e]=cb(e,src,width)},convolve:({buffer:e,width:r,height:t,kernel:i,start:s,end:g})=>{const a=new Uint8ClampedArray(e),c=a.slice(),l=Math.round(i.length/2)-1;let o=0;i.forEach(n=>n.forEach(f=>o+=Math.abs(f)));for(let n=s;n<=g;n++){const f=n%(r*4),u=Math.floor(n/(r*4));let y=0;i.forEach((p,m)=>p.forEach((h,x)=>{const w=f+(m-l)*4+(u+x-l)*r*4,d=c[w];d&&(y+=h*d/o)})),n%4!==3&&(a[n]=y)}return!0}};expose(Api)})();
